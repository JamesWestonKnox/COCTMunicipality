@model COCTMunicipality.Models.EventsAndAnnouncementsViewModel
@{
    ViewData["Title"] = "COCT - Events & Announcements";
    ViewData["BodyClass"] = "index-page";
}

<div class="content text-center">
    <h1 class="mb-5">Local Events and Announcements</h1>

    <div class="row justify-content-center">
        <div class="col-md-8 mb-4">
            <div class="card faded-card h-100 events-card">
                <div class="card-body p-4 d-flex flex-column">
                    <h4 class="mb-4 text-center text-dark">Events</h4>
                    <div class="mb-4">
                        <h5 class="mb-3 text-center text-dark">Search & Filter</h5>
                        <div class="d-flex justify-content-center align-items-center gap-3 flex-wrap mb-3">
                            <input type="text" id="searchInput" class="form-control search-input" placeholder="Search by name, category or date...">
                            <select id="filterCategory" class="form-select filter-select">
                                <option value="">Filter by Category</option>
                            </select>
                            <select id="sortValue" class="form-select filter-select">
                                <option value="">Sort by</option>
                            </select>
                        </div>
                        <div class="d-flex justify-content-center gap-3 mb-4">
                            <a href="/" class="btn btn-custom">Back</a>
                            <button id="resetBtn" class="btn btn-custom">Reset</button>
                        </div>
                    </div>
                    <div class="table-container flex-grow-1 overflow-auto">
                        <table class="table table-striped table-hover mb-0">
                            <thead class="table-light align-middle">
                                <tr>
                                    <th>Name</th>
                                    <th>Category</th>
                                    <th>Date</th>
                                    <th>Location</th>
                                </tr>
                            </thead>
                            <tbody id="eventsTable">
                                @foreach (var eventItem in Model.events)
                                {
                                    <tr class="align-middle event-row"
                                        data-id="@eventItem.EventId"
                                        data-name="@eventItem.Name"
                                        data-category="@eventItem.Category"
                                        data-date="@eventItem.Date.ToString("yyyy-MM-dd")"
                                        data-location="@eventItem.Location"
                                        data-description="@eventItem.Description">
                                        <td>@eventItem.Name</td>
                                        <td>@eventItem.Category</td>
                                        <td>@eventItem.Date.ToString("yyyy-MM-dd")</td>
                                        <td>@eventItem.Location</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-4">
            <div class="card faded-card announcements-card" style="height: 350px;">
                <div class="card-body p-4 d-flex flex-column" style="height: 100%;">
                    <h4 class="mb-3 text-center text-dark">Announcements</h4>
                    <div class="table-container flex-grow-1 overflow-auto">
                        <table class="table table-striped table-hover align-middle mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Name</th>
                                    <th>Location</th>
                                    <th>Date</th>
                                </tr>
                            </thead>
                            <tbody id="announcementsTable">
                                @foreach (var announcement in Model.announcements)
                                {
                                    <tr class="align-middle">
                                        <td>@announcement.Name</td>
                                        <td>@announcement.Location</td>
                                        <td>@announcement.Date.ToString("yyyy-MM-dd")</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="card faded-card recent-events-card mt-4" style="height: 350px;">
                <div class="card-body p-4 d-flex flex-column" style="height: 100%;">
                    <h4 class="mb-3 text-center text-dark">Recently Viewed Events</h4>
                    <div class="table-container flex-grow-1 overflow-auto">
                        <table class="table table-striped table-hover align-middle mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Name</th>
                                    <th>Category</th>
                                    <th>Date</th>
                                </tr>
                            </thead>
                            <tbody id="recentEventsTable">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="eventDetailsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalEventName">Event Name</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p><strong>Category:</strong> <span id="modalEventCategory"></span></p>
                <p><strong>Date:</strong> <span id="modalEventDate"></span></p>
                <p><strong>Location:</strong> <span id="modalEventLocation"></span></p>
                <p><strong>Description:</strong> <span id="modalEventDescription">No description available.</span></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
<style>
    body.index-page {
        background-image: url('@Url.Content("~/images/backgrounds/backgroundIndex.jpg")');
        background-size: cover;
        background-repeat: no-repeat;
        background-position: center;
        background-attachment: fixed;
        margin: 0;
        padding: 0;
        font-family: Arial, sans-serif;
    }

    .content {
        margin-top: 5vh;
        color: white;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.7);
    }

    .faded-card {
        background-color: rgba(255, 255, 255, 0.95);
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        text-shadow: none;
    }

        .faded-card h4, .faded-card h5 {
            color: black;
        }

    .btn-custom {
        background-color: #f0f0f0;
        border: 1px solid #ccc;
        color: black;
        padding: 10px 20px;
        border-radius: 8px;
        transition: background-color 0.3s ease, transform 0.2s ease;
    }

        .btn-custom:hover {
            background-color: #e0e0e0;
            transform: scale(1.05);
        }

    .form-control,
    .form-select {
        border-radius: 8px;
        border: 1px solid #ccc;
    }

    table th, table td {
        vertical-align: middle;
        text-align: left;
        word-wrap: break-word;
    }

    .search-input {
        width: 40%;
        min-width: 250px;
    }

    .filter-select {
        width: 25%;
        min-width: 150px;
    }

    .events-card .table-container {
        height: 450px;
        overflow-y: auto;
    }

    .announcements-card .table-container {
        overflow-y: auto;
    }

        .events-card .table-container table thead,
        .announcements-card .table-container table thead {
            position: sticky;
            top: 0;
            background-color: #f8f9fa;
            z-index: 1;
        }
</style>

<!--
    This script was generated and amended from ChatGPT
    Reference:
    OpenAI, 2025. ChatGPT [Computer program]. Version GPT-5 mini.
    Available at: https://chat.openai.com
-->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function () {

        function formatDate(dateValue) {
            if (!dateValue) return "N/A";
            try {
                let date = new Date(dateValue);
                if (isNaN(date)) {
                    const match = /Date\((\d+)\)/.exec(dateValue);
                    if (match) date = new Date(parseInt(match[1]));
                }
                return date.toISOString().split('T')[0];
            } catch {
                return dateValue;
            }
        }
        function refreshRecentEvents() {
            $.get('@Url.Action("GetLastViewedEvent", "Events")', function(data) {
                var tableBody = $('#recentEventsTable');
                tableBody.empty();
                data.forEach(function(ev) {
                    var row = `<tr class="align-middle">
                                    <td>${ev.name}</td>
                                    <td>${ev.category}</td>
                                    <td>${formatDate(ev.date)}</td>
                               </tr>`;
                tableBody.append(row);
                });
            });
        }

        refreshRecentEvents();

        $('#searchInput').on('input', function () {
            var searchTerm = $(this).val();
            $.ajax({
                url: '@Url.Action("SearchEvents", "Events")',
                type: 'GET',
                data: { searchTerm: searchTerm },
                success: function (data) {
                    var tableBody = $('#eventsTable');
                    tableBody.empty();
                    data.forEach(function (ev) {
                        var row = `<tr class="align-middle event-row"
                                        data-id="${ev.eventId}"
                                        data-name="${ev.name}"
                                        data-category="${ev.category}"
                                        data-date="${formatDate(ev.date)}"
                                        data-location="${ev.location}"
                                        data-description="${ev.description || ''}">
                                        <td>${ev.name}</td>
                                        <td>${ev.category}</td>
                                        <td>${formatDate(ev.date)}</td>
                                        <td>${ev.location}</td>
                                    </tr>`;
                        tableBody.append(row);
                    });
                }
            });
        });

        $('#eventsTable').on('click', '.event-row', function () {
            var row = $(this);
            var eventId = row.data('id');
            
            $.post('@Url.Action("AddLastViewedEvent", "Events")', { id: eventId }, function() 
            {
                refreshRecentEvents();
            });
            
            $('#modalEventName').text(row.data('name'));
            $('#modalEventCategory').text(row.data('category'));
            $('#modalEventDate').text(row.data('date'));
            $('#modalEventLocation').text(row.data('location'));
            $('#modalEventDescription').text(row.data('description') || 'No description available.');
            
            var modal = new bootstrap.Modal(document.getElementById('eventDetailsModal'));
            modal.show();
        });

        $('#resetBtn').on('click', function() 
        {
            $('#searchInput').val('');
            $('#filterCategory').val('');
            $('#sortValue').val('');
            $('#searchInput').trigger('input');
        });
});
</script>
